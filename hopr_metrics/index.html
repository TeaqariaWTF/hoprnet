<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="HOPR Metrics Collection"><title>hopr_metrics - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-b1a3e7f8283b8434.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="hopr_metrics" data-themes="" data-resource-suffix="" data-rustdoc-version="1.77.0-nightly (7ffc697ce 2024-01-24)" data-channel="nightly" data-search-js="search-dd67cee4cfa65049.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../static.files/storage-f2adc0d6ca4d09fb.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-48f368f3872407c8.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-04d5337699b92874.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../hopr_metrics/index.html">hopr_metrics</a><span class="version">1.1.0</span></h2></div><div class="sidebar-elems"><ul class="block">
            <li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#modules">Modules</a></li><li><a href="#macros">Macros</a></li></ul></section></div></nav><div class="sidebar-resizer"></div>
    <main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><div id="sidebar-button" tabindex="-1"><a href="../hopr_metrics/all.html" title="show sidebar"></a></div><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" tabindex="-1"><a href="../help.html" title="help">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Crate <a class="mod" href="#">hopr_metrics</a><button id="copy-path" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../src/hopr_metrics/lib.rs.html#1-153">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="hopr-metrics-collection"><a class="doc-anchor" href="#hopr-metrics-collection">§</a>HOPR Metrics Collection</h2>
<p>The purpose of the <code>hopr_metrics</code> Rust crate is to create a thin Rust WASM-compatible wrapper
over the <a href="https://docs.rs/prometheus/latest/prometheus/">Prometheus Metrics Rust API</a>.</p>
<p>The reason for making this wrapper is to make it suitable for <code>wasm-bindgen</code> bindings to JS/TS. The
<code>prometheus</code> crate API is not suitable for <code>wasm-bindgen</code> as it is. However, this crate can be also used
in pure Rust crates (either WASM or non-WASM compatible) and is not HOPR specific.</p>
<p>This wrapper merely simplifies the 3 basic Metric Types:</p>
<ul>
<li>Counter (integer only)</li>
<li>Gauge (floating point only)</li>
<li>Histogram (floating point only)</li>
</ul>
<p>The above 3 types are wrapped using the following structs:</p>
<ul>
<li><code>SimpleCounter</code></li>
<li><code>MultiCounter</code></li>
<li><code>SimpleGauge</code></li>
<li><code>MultiGauge</code></li>
<li><code>SimpleHistogram</code></li>
<li><code>MultiHistogram</code></li>
</ul>
<p>The “simple” types represent a singular named metrics, whereas the “multi” metrics represent a
vector extension.</p>
<p>The vector extensions basically maintain multiple labelled metrics in a single
entity. This makes it possible to have categorized metric values within a single metric, e.g.
counter of successful HTTP requests categorized by HTTP method.</p>
<p>The metrics are registered within global metrics registry (singleton).
Currently, the crate does not support additional individual registries apart from the global one.</p>
<h4 id="usage-in-rust-code"><a class="doc-anchor" href="#usage-in-rust-code">§</a>Usage in Rust code</h4>
<p>When writing pure Rust code that uses this crate, one can use the above structs by directly instantiating them.
During their construction, the metric registers itself in the global metrics registry.</p>
<h5 id="example-use-in-rust"><a class="doc-anchor" href="#example-use-in-rust">§</a>Example use in Rust</h5>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>hopr_metrics::metrics::<span class="kw-2">*</span>;

<span class="kw">let </span>metric_counter = SimpleCounter::new(<span class="string">"test_counter"</span>, <span class="string">"Some testing counter"</span>).unwrap();

<span class="comment">// Counter can be only incremented by integers only
</span>metric_counter.increment_by(<span class="number">10</span>);

<span class="kw">let </span>metric_gauge = SimpleGauge::new(<span class="string">"test_gauge"</span>, <span class="string">"Some testing gauge"</span>).unwrap();

<span class="comment">// Gauges can be incremented and decrements and support floats
</span>metric_gauge.increment(<span class="number">5.0</span>);
metric_gauge.decrement(<span class="number">3.2</span>);

<span class="kw">let </span>metric_histogram = SimpleHistogram::new(<span class="string">"test_histogram"</span>, <span class="string">"Some testing histogram"</span>, <span class="macro">vec!</span>[<span class="number">1.0</span>, <span class="number">2.0</span>]).unwrap();

<span class="comment">// Histograms can observe floating point values
</span>metric_histogram.observe(<span class="number">10.1</span>);

<span class="comment">// ... and also can be used to measure time durations in seconds
</span><span class="kw">let </span>timer = metric_histogram.start_measure();
std::thread::sleep(std::time::Duration::from_secs(<span class="number">1</span>));
metric_histogram.record_measure(timer);

<span class="comment">// Multi-metrics are labeled extensions
</span><span class="kw">let </span>metric_counts_per_version = MultiCounter::new(<span class="string">"test_multi_counter"</span>, <span class="string">"Testing labeled counter"</span>, <span class="kw-2">&amp;</span>[<span class="string">"version"</span>]).unwrap();

<span class="comment">// Tracks counters per different versions
</span>metric_counts_per_version.increment_by(<span class="kw-2">&amp;</span>[<span class="string">"1.0.0"</span>], <span class="number">2</span>);
metric_counts_per_version.increment_by(<span class="kw-2">&amp;</span>[<span class="string">"1.0.1"</span>], <span class="number">1</span>);

<span class="comment">// All metrics live in a global state and can be serialized at any time
</span><span class="kw">let </span>gathered_metrics = gather_all_metrics();

<span class="comment">// Metrics are in text format and can be exposed using an HTTP API endpoint
</span><span class="macro">println!</span>(<span class="string">"{:?}"</span>, gathered_metrics);</code></pre></div>
<h4 id="usage-in-jsts"><a class="doc-anchor" href="#usage-in-jsts">§</a>Usage in JS/TS</h4>
<p>Because the crate is WASM compatible, it contains also TS/JS bindings via
<code>wasm-bindgen</code>.
Once a metric is created, it lives in a global registry. Values of all
created metrics can be gathered in a serialized text for at any time.</p>
<p>See the example below for details.</p>
<h5 id="example-use-in-jsts"><a class="doc-anchor" href="#example-use-in-jsts">§</a>Example use in JS/TS</h5><div class="example-wrap"><pre class="language-js"><code>const metric_counter = create_counter(&#39;test_counter&#39;, &#39;Some testing counter&#39;)

// Counter can be only incremented by integers only
metric_counter.increment_by(10)

const metric_gauge = create_counter(&#39;test_gauge&#39;, &#39;Some testing gauge&#39;)

// Gauges can be incremented and decrements and support floats
metric_gauge.increment_by(5)
metric_gauge.decrement_by(3.2)

const metric_histogram = create_histogram(&#39;test_histogram&#39;, &#39;Some testing histogram&#39;)

// Histograms can observe floating point values
metric_histogram.observe(10.1)

// ... and also can be used to measure time durations in seconds
const timer = metric_histogram.start_measure()
foo()
metric_histogram.record_measure(timer)

// Multi-metrics are labeled extensions
const metric_countsPerVersion = create_multi_counter(&#39;test_multi_counter&#39;, &#39;Testing labeled counter&#39;, [&#39;version&#39;])

// Tracks counters per different versions
metric_countsPerVersion.increment_by(&#39;1.0.0&#39;, 2)
metric_countsPerVersion.increment_by(&#39;1.0.1&#39;, 1)

// All metrics live in a global state and can be serialized at any time
let gathered_metrics = gather_all_metrics()

// Metrics are in text format and can be exposed using an HTTP API endpoint
console.log(gathered_metrics)
</code></pre></div><h4 id="scraping-metrics-across-separate-wasm-runtimes-in-hoprd"><a class="doc-anchor" href="#scraping-metrics-across-separate-wasm-runtimes-in-hoprd">§</a>Scraping metrics across separate WASM runtimes in HOPRd</h4>
<p>Each WASM module runs in its own separate runtime and has a private memory space. This has implications for the metric
registries used by Prometheus in HOPRd. As a direct consequence of this fact, each WASM runtime has its own global metric
registry which has to be scraped separately in order to have all the metrics exposed.</p>
<p>Each Rust crate that will become a separate WASM runtime instantiated from the TS in HOPRd, must declare a public WASM-bound
function for gathering metrics:</p>
<div class="example-wrap"><pre class="language-js"><code>#[wasm_bindgen]
pub fn my_crate_gather_metrics() -&gt; JsResult&lt;String&gt; {
    hopr_metrics::metrics::wasm::gather_all_metrics()
}
</code></pre></div>
<p>and when initializing the crate in TS, <code>registerMetricsCollector</code> function must be called
passing the <code>my_crate_gather_metrics</code> as argument:</p>
<div class="example-wrap"><pre class="language-typescript"><code>import registerMetricsCollector from &#39;@hoprnet/hopr-utils&#39;
import { my_crate_initialize_crate, my_crate_gather_metrics } from &#39;../lib/my_crate.js&#39;
my_crate_initialize_crate()
registerMetricsCollector(my_crate_gather_metrics)
</code></pre></div></div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="metrics/index.html" title="mod hopr_metrics::metrics">metrics</a></div></li></ul><h2 id="macros" class="section-header">Macros<a href="#macros" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="macro" href="macro.histogram_start_measure.html" title="macro hopr_metrics::histogram_start_measure">histogram_start_measure</a></div></li></ul></section></div></main></body></html>